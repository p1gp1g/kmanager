#!/bin/bash

source __CONF__

usage() {
cat <<EOF
Usage: $0 sys [<vm>]
       $0 rw <vm>
EOF
exit 0
}

# update old new
update() {
	qemu-img commit "$1"
	qemu-img commit "$2"
	rm $SYS_DIR/*
	for name in $(sqlite3 $DB "SELECT name FROM vms;"); do
		qemu-img create -f qcow2 -F qcow2 -b "$TEMPLATE_DIR/$SYS_TEMPLATE" "$SYS_DIR/$name.qcow2" $SYS_SIZE
	done
}

run_update() {
	kcreate update || exit 1
	virsh start update || exit 1
	ssh update sudo dnf update -y || exit 1
	echo -n "Commit changes ? (y/n) "
	read commit
	case commit in
		y|Y)
			update "$TEMPLATE_DIR/$SYS_TEMPLATE" "$SYS_DIR/update.qcow2"
		;;
		*)
			echo "Aborted"
		;;
	esac
	virsh shutdown update
	kdelete update
	exit 0
}

[ $# -lt 1 ] && usage

case $1 in
  s|sys)
		[ -z "$2" ] && run_update
		TEMPLATE="$TEMPLATE_DIR/$SYS_TEMPLATE"
	;;
	r|rw)
		[ -z "$2" ] && usage
		TEMPLATE="$TEMPLATE_DIR/$RW_TEMPLATE"
	;;
	*)
		usage
	;;
esac

NEW="$SYS_DIR/$2.qcow2"
[ -f "$NEW" ] || usage
update "$TEMPLATE" "$NEW"

